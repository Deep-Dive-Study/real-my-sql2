# 15 데이터 타입

컬럼 타입을 결정하는 것은 물리 모델링에서 매우 중요한 작업이다.

- 저장되는 값에 최적의 타입 지정
- 가변 길이 컬럼은 최적의 길이 지정
- 조인 조건으로 사용되는 컬럼은 똑같은 타입 지정

* MySQL에서 TEXT와 BLOB을 제외하면 컬럼 전체 크기가 64KB를 초과할 수 없다. 예를들어 한 컬럼이 40KB 차지하면, 다른 컬럼들은 24KB를 넘을 수 없다.

# 1. 문자열

문자열 타입은 CHAR, VARCHAR 두가지로 나뉜다.

### 저장공간

CHAR는 길이가 고정이고, VARCHAR는 가변이라 크기를 저장하기 위해 1~2 바이트의 저장공간을 추가로 사용한다. (255바이트까지 1, 그 이상은 2이다. 그보다 큰 크기는 사용 불가)

* VARCHAR(n) 에서 n은 문자 개수이기 때문에 안에 어떤 문자가 들어가냐에 따라 크기가 달라진다.

판단 기준

- 문자열의 길이가 대개 비슷한가.
- 컬럼의 값이 자주 변경되는가.

VARCHAR가 UPDATE될 때 공간이 부족하면 Row migration이 일어나기 때문이다.

* MySQL엔 utf8mb4 라는 문자 집합이 있다. 찾아보면 좋다.

## 1.2 저장 공간과 스키마 변경

Online DDL : 데이터가 변경되는 도중에도 스키마 변경이 가능한 기능. (항상 가능한건 아니다)

- 수정할 때 ALGORITHM=INPLACE를 사용하면 모든 작업이 가능하다.
- utf8mb4 VARCHAR의 길이를 64 이하에서 64 이상으로 변경하면 INPLACE가 불가능하다.
    - 문자열 길이를 저장하는 공간의 크기가 1 → 2 바이트로 변경되기 때문이다.

따라서 컬럼을 생성할 때 조금은 여유있게 만들면 좋다.

## 1.3 문자 집합

`SHOW CHARACTER SET` 을 통해 사용가능한 문자 집합을 조회할 수 있다.

- 각 테이블과 컬럼은 서로 다른 문자 집합을 사용해 문자열을 저장할 수 있다.
- 문자 집합은 CHAR, VARCHAR, TEXT에만 설정 가능

* 한글은 보통 euckr, utf8mb4로 지정

* NCHAR 타입도 있지만 사용할 일은 없다.

관련 변수

- character_set_system - MySQL서버가 식별자를 저장할 때 사용하는 문자 (utf8)
- character_set_server - MySQL 서버의 기본 문자 집합 (utf8mb4)
- character_set_database - DB의 기본 문자 집합 (utf8mb4)
- character_set_filesystem - Load Data, INTO OUTFILE 을 실행할때 사용되는 인자 (binary, utf8mb4로 변경 추천)
- character_set_client - 클라이언트가 보낸 SQL 문장이 해당하는 문자 집합으로 인코딩되어 전송된다.(utf8mb4)
- character_set_connection - 클라이언트에게 전달받은 SQL 문장을 처리하기 위해 변환하는 문자 집합 (utf8mb4)
- character_set_results - MySQL 서버가 쿼리 결과를 보낼때 사용하는 문자 집합 (utf8mb4)

대부분의 default 문자 집합은 utf8mb4이다. 

client, connection, results는 왜 나눈건지 모르겠다.

**쿼리 요청시 문자 집합 변환을 피하는 법**

기본적으론 character_set에 지정된 문자 집합으로 자동 변환된다. 하지만 별도의 문자 집합 리터럴이 포함된 경우는 변환하지 않는다.

```sql
SELECT * FROM TABLE_NAME WHERE COLUMN1 = _latin1'MATT';
```

_와 함께 문자열 리터럴을 붙이면 된다.

**결과 반환시 문자 집합 변환을 피하는 법**

- 쿼리를 MySQL 서버로 전송할 때 
chraracter_set_client, character_set_connection 의 문자집합이 같은경우 변환되지 않는다.
- 쿼리 결과를 클라이언트로 전송할 때
character_set_connection, chracter_set_results가 같다면 변환되지 않는다.

세가지 모두 변수여서 변경할 수 있음.

`SET NAMES …` 또는 `CHARSET …` 으로 한 번에 변경 가능

## 1.4 콜레이션

콜레이션 : 문자열 컬럼 값 비교나 정렬 순서 법칙

컬럼 값 비교나, 정렬할 때 동일한 콜레이션 유무는 쿼리 성능에 상당한 영향을 준다.

### 1. 콜레이션 이해

- 하나의 문자 집합에 속한 콜레이션은 다른 문자 집합과 공유해서 사용 불가.
- 콜레이션을 명시하지 않으면 디폴트로 지정, 콜레이션만 지정하면 문자열이 지정
- 콜레이션은 `SHOW COLLATION`으로 조회

콜레이션 작명법

- 콜레이션은 2~3개의 파트로 구분됨
- 첫 번째 파트는 문자 집합 이름(utf8, latin1 등등)
- 두 번째 파트는 해당 문자 집합의 하위 분류
- 세 번째 파트는 대소문자 구분 여부 (ci = 구분안함, cs = 구분함, ai = 액센트 구분안함, as = 액센트 구분함)

* 2개로 구성된 콜레이션의 두번째 파트는 이진데이터로 관리되어 별도의 콜레이션이 없다.

예를 들어 utf8mb4_0900_ci를 보자

- utf8mb4 집합
- 0900은 UCA(Unicode Collation Algorithm)의 버전을 뜻한다.
- ci는 대소문자를 구분하지 않는다는 뜻

문자를 비교할 때 콜레이션까지 같아야 같은 컬럼이 된다. 효율적인 검색을 위해선 콜레이션까지 맞추는게 좋다.

### 2. utf8mb4 문자 집합의 콜레이션

언어 비종속적인 콜레이션은 문자 셋의 기본 정렬 순서에 의해 정렬한다.

그외에 각 언어에 종속적인 콜레이션은 해당 언어데서 정의한 순서에 의해 정렬된다.

UCA 9.0.0 버전은 빠른 콜레이션으로 설명되고 있다.

~~실제론 아님~~ 하지만 최신 정렬 순서를 반영하고 있다는점

![image](https://github.com/Deep-Dive-Study/real-my-sql2/assets/85796588/ee47f304-8cc4-4b56-b0ee-3c5a379f3920)

## 1.5 비교 방식

CHAR, VARCHAR 거의 같음

먼저 비교하는 문자열의 길이를 동일하게 만든다. (문자열 우측의 공백은 제거)

- UCA 9.0.0은 우측 공백도 영향을 준다.
- 우측 공백이 영향을 미치는지는 information_schema.COLLATION의 PAD_ATTRIBUTE를 확인하자.

### 6. 문자열 이스케이프 처리

- \0 - NULL
- \’ - ‘
- \” - “
- \b - 백스페이스
- \n - 개행라인
- \r - 캐리지 리턴 (유닉스 계열에서 사용)
- \t - 탭
- \\ - \
- \% - %
- \_ - _

홑따옴표나 쌍따옴표 두개를 사용해 이스케이프 처리도 가능하다.

‘ab’’ba’ → ab’ba

‘ab””ba’ → ab”ba

# 2. 숫자.

숫자 타입은 정확도에 따라 참값과 근삿값으로 나뉜다.

- 참값 - 소수점 이하의 유무와 관계없이 그 값을 그대로 유지하는 것 (INT, DEMICAL)
- 근삿값 - 부동 소수점을 뜻한다. (FLOAT, DOUBLE)

숫자 타입은 저장되는 포맷에 따라 십진법과 이진법으로 나뉜다.

- 이진 - 메모리나 디스크 공간을 적게 사용한다. 정수, 실수 (INTEGER, BIGINT)
- 십진 - 각 자리값을 4비트나 1바이트를 사용한다. 정확하게 소수점까지 관리되야하는 값에 사용된다.(DEMICAL)

DBMS에서 근삿값은 저장할 때와 조회할 때 값이 정확히 일치하지 않고, 유효 자리수를 넘어서면 값이 매번 바뀐다.

## 2.1 정수

![image](https://github.com/Deep-Dive-Study/real-my-sql2/assets/85796588/38859f27-ce86-49f1-9d2d-76c282486c14)

UNSINGED 옵션을 달면 양수만 생성하고, 그렇지 않다면 음수와 양수 모두 저장 가능하다.

UNSIGNED 옵션 유무가 비교나 조인에 영향을 주진 않지만, 일치시키는 것이 좋다.

## 2.2 부동 소수점

숫자 값의 길이에 따라 유효 범위의 소수점 자리수가 바뀐다.

따라서 정확한 유효 소수점 값을 식별하기 어렵고 비교하기 어렵다.

- FLOAT - 4바이트 사용, 유효 자리수 8개, 정밀도 명시된 경우 최대 8바이트 사용
- DOUBLE - 9바이트 사용, 최대 유효자리수 16개

부동 소수점은 바이너리 로그 포맷이 STATEMENT인 경우 소스 서버와 레플리카 서버의 데이터가 달라질 수 있다.

부동 소수점을 저장할 때 유효자리수만큼 곱해서 저장하는 방법을 고려해보자.

## 2.3 DEMICAL

소수점 위치가 가변적이지 않으며, 정확한 값을 보장한다. 단 그만큼 공간을 많이 차지한다.

정수를 관리한다면 조금 더 빠른 INTEGER류를 사용하라.

## 2.4 주의 사항

부동 소수점이나 DEMICAL 타입을 이용할 땐 이름 뒤에 정밀도를 표시하는 것이 일반적이다.

MySQL. 5.7까지 정수 타입에도 괄호로 크기를 명시할 수 있는 문법이 있었는데, 정수 타입은 고정형이기 때문에 데이터의 길이와 전혀 무관하다.

## 2.5 AUTO_INCREMENT 옵션

AUTO_INCREMENT : 컬럼을 자동으로 증가하게 해준다. 테이블당 하나만 사용 가능

auto_increment_offset - 첫 숫자

auto_increment_increment - 증가량

AUTO_INCREMENT 옵션을 사용한 컬럼은 반드시 PK, UK의 일부로 정의되어야 한다.

- MyISAM - PK, UK의 아무위치나 사용 가능
- InnoDB - PK, UK의 시작 위치에 사용
